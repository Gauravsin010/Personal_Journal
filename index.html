<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #aaa;
            font-size: 1.1rem;
        }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-tab.active {
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            color: #0f2027;
            font-weight: bold;
        }
        
        .nav-tab:hover {
            transform: translateY(-2px);
        }
        
        /* Page Content */
        .page-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .page-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #00c9ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-box {
            background: rgba(0, 201, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-box h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #92fe9d;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .positive {
            color: #00ff8c;
        }
        
        .negative {
            color: #ff4069;
        }
        
        /* Forms */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        input, select, textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            color: #0f2027;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(0, 0, 0, 0.2);
            color: #00c9ff;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-container {
            height: 300px;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #00c9ff;
        }
        
        .monthly-table {
            width: 100%;
            margin-top: 20px;
        }
        
        .monthly-table th {
            text-align: center;
        }
        
        .monthly-table td {
            text-align: center;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .export-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <div id="auth-container" style="max-width:400px;margin:40px auto;display:none;">
    <div class="card">
        <h2><i class="fas fa-user"></i> Login / Register</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit">Login / Register</button>
        </form>
    </div>
</div>

<div id="app-container" style="display:none;">

    <div class="container">
        <header>
            <button id="logout-btn" class="btn-secondary" style="float:right;margin-top:-10px;">
    <i class="fas fa-sign-out-alt"></i> Logout
</button>
            <h1><i class="fas fa-chart-line"></i> Advanced Trading Journal</h1>
            <p class="subtitle">Track your trades and analyze your performance</p>
        </header>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="nav-tab" data-page="data-entry">
                <i class="fas fa-pen"></i> Data Entry
            </div>
            <div class="nav-tab" data-page="trade-history">
                <i class="fas fa-table"></i> Trade History
            </div>
            <div class="nav-tab" data-page="analytics">
                <i class="fas fa-chart-pie"></i> Analytics
            </div>
            <div class="nav-tab" data-page="export">
                <i class="fas fa-file-export"></i> Export Data
            </div>
        </div>
        
        <!-- Dashboard Page -->
        <div id="dashboard" class="page-content active">
            <div class="dashboard">
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> Performance Summary</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <h3>Total Trades</h3>
                            <div class="stat-value" id="total-trades">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Win Rate</h3>
                            <div class="stat-value" id="win-rate">0%</div>
                        </div>
                        <div class="stat-box">
                            <h3>Avg. Win</h3>
                            <div class="stat-value" id="avg-win">₹0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Avg. Loss</h3>
                            <div class="stat-value" id="avg-loss">₹0</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-wallet"></i> Profit & Loss</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <h3>Total P&L</h3>
                            <div class="stat-value" id="total-pl">₹0</div>
                        </div>
                        <div class="stat-box">
                            <h3>This Month</h3>
                            <div class="stat-value" id="monthly-pl">₹0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Best Trade</h3>
                            <div class="stat-value" id="best-trade">₹0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Worst Trade</h3>
                            <div class="stat-value" id="worst-trade">₹0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="card">
                    <h2><i class="fas fa-chart-area"></i> Equity Curve</h2>
                    <div class="chart-container">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-chart-pie"></i> Win/Loss Distribution</h2>
                    <div class="chart-container">
                        <canvas id="winLossChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Entry Page -->
        <div id="data-entry" class="page-content">
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> Add New Trade</h2>
                <form id="trade-form" class="trade-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="symbol">Symbol</label>
                            <input type="text" id="symbol" placeholder="e.g. RELIANCE" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="direction">Direction</label>
                            <select id="direction" required>
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="entry">Entry Price</label>
                            <input type="number" id="entry" step="0.01" placeholder="0.00" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="exit">Exit Price</label>
                            <input type="number" id="exit" step="0.01" placeholder="0.00" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" placeholder="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="strategy">Strategy</label>
                            <select id="strategy">
                                <option value="">Select Strategy</option>
                                <option value="breakout">Breakout</option>
                                <option value="reversal">Reversal</option>
                                <option value="trend">Trend Following</option>
                                <option value="scalping">Scalping</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="timeframe">Timeframe</label>
                            <select id="timeframe">
                                <option value="">Select Timeframe</option>
                                <option value="intraday">Intraday</option>
                                <option value="swing">Swing</option>
                                <option value="position">Position</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="risk">Risk %</label>
                            <input type="number" id="risk" step="0.1" placeholder="1.0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Trade Notes</label>
                        <textarea id="notes" placeholder="Enter your trade notes here..."></textarea>
                    </div>
                    
                    <button type="submit">Add Trade</button>
                </form>
            </div>
        </div>
        
        <!-- Trade History Page -->
        <div id="trade-history" class="page-content">
            <div class="card">
                <h2><i class="fas fa-table"></i> Trade History</h2>
                <div class="table-container">
                    <table id="trades-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>Qty</th>
                                <th>P&L</th>
                                <th>Cumulative</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="empty-row">
                                <td colspan="9">
                                    <div class="empty-state">
                                        <i class="fas fa-folder-open"></i>
                                        <h3>No trades recorded yet</h3>
                                        <p>Add your first trade using the Data Entry tab</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button id="export-btn" class="btn-secondary"><i class="fas fa-file-export"></i> Export Data</button>
                    <button id="clear-btn" class="btn-secondary"><i class="fas fa-trash"></i> Clear History</button>
                </div>
            </div>
        </div>
        
        <!-- Analytics Page -->
        <div id="analytics" class="page-content">
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Performance Analytics</h2>
                <div class="chart-grid">
                    <div class="chart-container">
                        <canvas id="strategyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="timeframeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-calendar"></i> Monthly Performance</h2>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                
                <div class="table-container">
                    <table class="monthly-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Number of Trades</th>
                                <th>Winning Trades</th>
                                <th>Losing Trades</th>
                                <th>Win Rate</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-stats">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <i class="fas fa-chart-line"></i>
                                    <h3>No monthly data available</h3>
                                    <p>Add trades to see monthly performance</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-analytics"></i> Advanced Metrics</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <h3>Profit Factor</h3>
                        <div class="stat-value" id="profit-factor">0.00</div>
                    </div>
                    <div class="stat-box">
                        <h3>Expectancy</h3>
                        <div class="stat-value" id="expectancy">₹0</div>
                    </div>
                    <div class="stat-box">
                        <h3>Sharpe Ratio</h3>
                        <div class="stat-value" id="sharpe-ratio">0.00</div>
                    </div>
                    <div class="stat-box">
                        <h3>Max Drawdown</h3>
                        <div class="stat-value" id="max-drawdown">0.0%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export Page -->
        <div id="export" class="page-content">
            <div class="card">
                <h2><i class="fas fa-file-export"></i> Export Trading Data</h2>
                <p>Export your trading data to various formats for analysis or record keeping.</p>
                
                <div class="action-buttons">
                    <div class="export-options">
                        <button id="export-csv" class="btn-secondary">
                            <i class="fas fa-file-csv"></i> Export to CSV (Excel)
                        </button>
                        <button id="export-txt" class="btn-secondary">
                            <i class="fas fa-file-alt"></i> Export to Text File
                        </button>
                        <button id="export-json" class="btn-secondary">
                            <i class="fas fa-file-code"></i> Export to JSON
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-database"></i> Data Preview</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data Type</th>
                                    <th>Record Count</th>
                                    <th>Export Size</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Trades</td>
                                    <td id="export-trade-count">0</td>
                                    <td id="export-trade-size">0 KB</td>
                                </tr>
                                <tr>
                                    <td>Monthly Stats</td>
                                    <td id="export-monthly-count">0</td>
                                    <td id="export-monthly-size">0 KB</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

    <script>

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDrEy-pw9e4A6ovgUsaQK6jgLfEfsk18hg",
            authDomain: "personaljournal-6c313.firebaseapp.com",
            projectId: "personaljournal-6c313",
            storageBucket: "personaljournal-6c313.firebasestorage.app",
            messagingSenderId: "555068776330",
            appId: "1:555068776330:web:b6fb5496829e14a8577273"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Data storage - now using Firestore instead of localStorage
        let trades = [];
        let equityCurve = [0];
        let isLoading = false;
        
        // Loading state management
        const setLoading = (loading) => {
            isLoading = loading;
            // You can add loading indicators here if needed
        };

        

        const showApp = () => {
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('app-container').style.display = '';
};
const showLogin = () => {
    document.getElementById('auth-container').style.display = '';
    document.getElementById('app-container').style.display = 'none';
};

showLogin();

document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    try {
        // Try login
        await auth.signInWithEmailAndPassword(email, password);
    } catch (err) {
        // If user not found, register
        if (err.code === 'auth/user-not-found') {
            await auth.createUserWithEmailAndPassword(email, password);
        } else {
            alert(err.message);
        }
    }
});

auth.onAuthStateChanged(async (user) => {
    if (user) {
        showApp();
        await initializeData();
        initCharts();
        updateTradeTable();
        updateCharts();
        updateMetrics();
        updateMonthlyStats();
        updateExportStats();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
    } else {
        showLogin();
    }
});

const addTrade = async (trade) => {
    try {
        setLoading(true);
        const user = auth.currentUser; // <-- Add this line
        if (!user) throw new Error('Not logged in'); // Optional safety check
        const docRef = await db.collection('trades').add({
            ...trade,
            userId: user.uid, // <-- Use user.uid here
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Add the document ID to the trade object
        trade.id = docRef.id;
        trades.push(trade);
        
        // Update equity curve
        updateEquityCurve();
        
        // Save to localStorage as backup
        localStorage.setItem('trades', JSON.stringify(trades));
        localStorage.setItem('equityCurve', JSON.stringify(equityCurve));
        
        return docRef.id;
    } catch (error) {
        console.error('Error adding trade:', error);
        alert('Failed to add trade: ' + error.message);
        throw error;
    } finally {
        setLoading(false);
    }
};
// ...existing code...

        

        // // CRUD Operations for Trades
        // const addTrade = async (trade) => {
        //     try {
        //         setLoading(true);
        //         const docRef = await db.collection('trades').add({
        //             ...trade,
        //             userId: user.uid,
        //             createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        //             updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        //         });
                
        //         // Add the document ID to the trade object
        //         trade.id = docRef.id;
        //         trades.push(trade);
                
        //         // Update equity curve
        //         updateEquityCurve();
                
        //         // Save to localStorage as backup
        //         localStorage.setItem('trades', JSON.stringify(trades));
        //         localStorage.setItem('equityCurve', JSON.stringify(equityCurve));
                
        //         return docRef.id;
        //     } catch (error) {
        //         console.error('Error adding trade:', error);
        //         alert('Failed to add trade: ' + error.message);
        //         throw error;
        //     } finally {
        //         setLoading(false);
        //     }
        // };

        const updateTrade = async (tradeId, updatedTrade) => {
            try {
                setLoading(true);
                await db.collection('trades').doc(tradeId).update({
                    ...updatedTrade,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local array
                const index = trades.findIndex(t => t.id === tradeId);
                if (index !== -1) {
                    trades[index] = { ...trades[index], ...updatedTrade };
                    updateEquityCurve();
                    
                    // Update localStorage
                    localStorage.setItem('trades', JSON.stringify(trades));
                    localStorage.setItem('equityCurve', JSON.stringify(equityCurve));
                }
            } catch (error) {
                console.error('Error updating trade:', error);
                alert('Failed to update trade: ' + error.message);
                throw error;
            } finally {
                setLoading(false);
            }
        };

        const deleteTrade = async (tradeId) => {
            try {
                setLoading(true);
                await db.collection('trades').doc(tradeId).delete();
                
                // Remove from local array
                const index = trades.findIndex(t => t.id === tradeId);
                if (index !== -1) {
                    trades.splice(index, 1);
                    updateEquityCurve();
                    
                    // Update localStorage
                    localStorage.setItem('trades', JSON.stringify(trades));
                    localStorage.setItem('equityCurve', JSON.stringify(equityCurve));

                    updateTradeTable();
            updateCharts();
            updateMetrics();
                }
            } catch (error) {
                console.error('Error deleting trade:', error);
                alert('Failed to delete trade: ' + error.message);
                throw error;
            } finally {
                setLoading(false);
            }
        };

        const fetchTrades = async () => {
            try {
                setLoading(true);
                const user = auth.currentUser;
                if (!user) throw new Error('Not logged in');
        const snapshot = await db.collection('trades')
            .where('userId', '==', user.uid)
            .orderBy('date', 'desc')
            .get();
                
                trades = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update equity curve
                updateEquityCurve();
                
                // Save to localStorage as backup
                localStorage.setItem('trades', JSON.stringify(trades));
                localStorage.setItem('equityCurve', JSON.stringify(equityCurve));
                
                return trades;
            } catch (error) {
                console.error('Error fetching trades:', error);
                // Fallback to localStorage if Firestore fails
                const localTrades = JSON.parse(localStorage.getItem('trades')) || [];
                const localEquity = JSON.parse(localStorage.getItem('equityCurve')) || [0];
                trades = localTrades;
                equityCurve = localEquity;
                alert('Failed to fetch trades from cloud, using local data: ' + error.message);
                return trades;
            } finally {
                setLoading(false);
            }
        };

        // Update equity curve based on current trades
        const updateEquityCurve = () => {
            equityCurve = [0];
            let cumulative = 0;
            trades.forEach(trade => {
                cumulative += trade.profit;
                equityCurve.push(cumulative);
            });
        };

        // Real-time listener for trades (optional - for multi-user scenarios)
        const setupRealtimeListener = () => {
            db.collection('trades')
                .orderBy('date', 'desc')
                .onSnapshot((snapshot) => {
                    const changes = snapshot.docChanges();
                    changes.forEach((change) => {
                        if (change.type === 'added') {
                            const newTrade = { id: change.doc.id, ...change.doc.data() };
                            const exists = trades.find(t => t.id === newTrade.id);
                            if (!exists) {
                                trades.unshift(newTrade);
                                updateEquityCurve();
                            }
                        } else if (change.type === 'modified') {
                            const updatedTrade = { id: change.doc.id, ...change.doc.data() };
                            const index = trades.findIndex(t => t.id === updatedTrade.id);
                            if (index !== -1) {
                                trades[index] = updatedTrade;
                                updateEquityCurve();
                            }
                        } else if (change.type === 'removed') {
                            const removedTradeId = change.doc.id;
                            const index = trades.findIndex(t => t.id === removedTradeId);
                            if (index !== -1) {
                                trades.splice(index, 1);
                                updateEquityCurve();
                            }
                        }
                    });
                    
                    // Update UI
                    updateTradeTable();
                    updateCharts();
                    updateMetrics();
                    updateMonthlyStats();
                    updateExportStats();
                }, (error) => {
                    console.error('Real-time listener error:', error);
                });
        };

        // Initialize data from Firestore or localStorage
        const initializeData = async () => {
            try {
                await fetchTrades();
            } catch (error) {
                console.error('Failed to initialize data:', error);
                // Use localStorage as fallback
                const localTrades = JSON.parse(localStorage.getItem('trades')) || [];
                const localEquity = JSON.parse(localStorage.getItem('equityCurve')) || [0];
                trades = localTrades;
                equityCurve = localEquity;
            }
        };

        // Data storage
        // let trades = JSON.parse(localStorage.getItem('trades')) || [];
        // let equityCurve = JSON.parse(localStorage.getItem('equityCurve')) || [0];
        
        // Navigation functionality
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Hide all page content
                document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                
                // Show the selected page
                const pageId = tab.getAttribute('data-page');
                document.getElementById(pageId).classList.add('active');
                
                // Update charts if navigating to dashboard or analytics
                if (pageId === 'dashboard' || pageId === 'analytics') {
                    updateCharts();
                    updateMetrics();
                    updateMonthlyStats();
                }
                
                // Update export page stats
                if (pageId === 'export') {
                    updateExportStats();
                }
            });
        });
        
        // Initialize charts
        let equityChart, winLossChart, strategyChart, timeframeChart, monthlyChart;
        
        const initCharts = () => {
            // Equity Curve Chart
            const equityCtx = document.getElementById('equityChart').getContext('2d');
            equityChart = new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: [],
                        borderColor: '#00ff8c',
                        backgroundColor: 'rgba(0, 255, 140, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
            
            // Win/Loss Chart
            const winLossCtx = document.getElementById('winLossChart').getContext('2d');
            winLossChart = new Chart(winLossCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Winning Trades', 'Losing Trades'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#00ff8c', '#ff4069'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
            
            // Strategy Performance Chart
            const strategyCtx = document.getElementById('strategyChart').getContext('2d');
            strategyChart = new Chart(strategyCtx, {
                type: 'bar',
                data: {
                    labels: ['Breakout', 'Reversal', 'Trend', 'Scalping'],
                    datasets: [{
                        label: 'Average P&L per Trade',
                        data: [0, 0, 0, 0],
                        backgroundColor: '#00c9ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
            
            // Timeframe Performance Chart
            const timeframeCtx = document.getElementById('timeframeChart').getContext('2d');
            timeframeChart = new Chart(timeframeCtx, {
                type: 'pie',
                data: {
                    labels: ['Intraday', 'Swing', 'Position'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#00c9ff', '#00ff8c', '#ff4069']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
            
            // Monthly Performance Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Monthly P&L',
                        data: [],
                        backgroundColor: '#00c9ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
        };
        
        // Calculate monthly performance
        const calculateMonthlyPerformance = () => {
            if (trades.length === 0) return {};
            
            const monthlyData = {};
            
            trades.forEach(trade => {
                const date = new Date(trade.date);
                const monthYear = `${date.toLocaleString('default', { month: 'short' })} ${date.getFullYear()}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        totalTrades: 0,
                        winningTrades: 0,
                        losingTrades: 0,
                        totalPL: 0
                    };
                }
                
                monthlyData[monthYear].totalTrades++;
                monthlyData[monthYear].totalPL += trade.profit;
                
                if (trade.profit > 0) {
                    monthlyData[monthYear].winningTrades++;
                } else {
                    monthlyData[monthYear].losingTrades++;
                }
            });
            
            return monthlyData;
        };
        
        // Update monthly stats table
        const updateMonthlyStats = () => {
            const monthlyData = calculateMonthlyPerformance();
            const monthlyStatsBody = document.getElementById('monthly-stats');
            
            monthlyStatsBody.innerHTML = '';
            
            if (Object.keys(monthlyData).length === 0) {
                monthlyStatsBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <h3>No monthly data available</h3>
                            <p>Add trades to see monthly performance</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Update monthly chart
            const months = Object.keys(monthlyData);
            const monthlyPL = months.map(month => monthlyData[month].totalPL);
            
            monthlyChart.data.labels = months;
            monthlyChart.data.datasets[0].data = monthlyPL;
            monthlyChart.update();
            
            // Update monthly table
            months.forEach(month => {
                const data = monthlyData[month];
                const winRate = data.totalTrades > 0 ? 
                    Math.round((data.winningTrades / data.totalTrades) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>${data.totalTrades}</td>
                    <td>${data.winningTrades}</td>
                    <td>${data.losingTrades}</td>
                    <td>${winRate}%</td>
                    <td class="${data.totalPL >= 0 ? 'positive' : 'negative'}">${data.totalPL >= 0 ? '+' : ''}${data.totalPL.toFixed(2)}</td>
                `;
                
                monthlyStatsBody.appendChild(row);
            });
        };
        
        // Update export statistics
        const updateExportStats = () => {
            const monthlyData = calculateMonthlyPerformance();
            
            document.getElementById('export-trade-count').textContent = trades.length;
            document.getElementById('export-trade-size').textContent = `${(JSON.stringify(trades).length / 1024).toFixed(2)} KB`;
            
            document.getElementById('export-monthly-count').textContent = Object.keys(monthlyData).length;
            document.getElementById('export-monthly-size').textContent = `${(JSON.stringify(monthlyData).length / 1024).toFixed(2)} KB`;
        };
        
        // Export data to CSV
        const exportToCSV = () => {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }
            
            const csvContent = "Date,Symbol,Direction,Entry Price,Exit Price,Quantity,Profit/Loss,Strategy,Timeframe,Risk %,Notes\n" +
                trades.map(trade => 
                    `"${trade.date}","${trade.symbol}","${trade.direction}",${trade.entry},${trade.exit},${trade.quantity},${trade.profit},"${trade.strategy || ''}","${trade.timeframe || ''}",${trade.risk || ''},"${trade.notes || ''}"`
                ).join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "trading_journal_export.csv");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // Export data to TXT
        const exportToTXT = () => {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }
            
            let txtContent = "TRADING JOURNAL EXPORT\n";
            txtContent += "=====================\n\n";
            
            txtContent += `Export Date: ${new Date().toLocaleDateString()}\n`;
            txtContent += `Total Trades: ${trades.length}\n\n`;
            
            txtContent += "TRADE HISTORY:\n";
            txtContent += "=============\n\n";
            
            trades.forEach((trade, index) => {
                txtContent += `Trade #${index + 1}:\n`;
                txtContent += `Date: ${trade.date}\n`;
                txtContent += `Symbol: ${trade.symbol}\n`;
                txtContent += `Direction: ${trade.direction}\n`;
                txtContent += `Entry: ${trade.entry}\n`;
                txtContent += `Exit: ${trade.exit}\n`;
                txtContent += `Quantity: ${trade.quantity}\n`;
                txtContent += `P&L: ${trade.profit}\n`;
                txtContent += `Strategy: ${trade.strategy || 'N/A'}\n`;
                txtContent += `Timeframe: ${trade.timeframe || 'N/A'}\n`;
                txtContent += `Risk %: ${trade.risk || 'N/A'}\n`;
                txtContent += `Notes: ${trade.notes || 'N/A'}\n\n`;
            });
            
            // Add monthly summary
            const monthlyData = calculateMonthlyPerformance();
            if (Object.keys(monthlyData).length > 0) {
                txtContent += "MONTHLY SUMMARY:\n";
                txtContent += "===============\n\n";
                
                Object.keys(monthlyData).forEach(month => {
                    const data = monthlyData[month];
                    const winRate = data.totalTrades > 0 ? 
                        Math.round((data.winningTrades / data.totalTrades) * 100) : 0;
                    
                    txtContent += `${month}: ${data.totalTrades} trades, ${winRate}% win rate, P&L: ${data.totalPL}\n`;
                });
            }
            
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "trading_journal_export.txt");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // Export data to JSON
        const exportToJSON = () => {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                trades: trades,
                monthlyData: calculateMonthlyPerformance(),
                statistics: {
                    totalTrades: trades.length,
                    winningTrades: trades.filter(t => t.profit > 0).length,
                    losingTrades: trades.filter(t => t.profit <= 0).length,
                    totalPL: trades.reduce((sum, t) => sum + t.profit, 0)
                }
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "trading_journal_export.json");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // Update charts with current data
        const updateCharts = () => {
            if (trades.length === 0) {
                equityChart.data.labels = [];
                equityChart.data.datasets[0].data = [0];
                winLossChart.data.datasets[0].data = [0, 0];
                strategyChart.data.datasets[0].data = [0, 0, 0, 0];
                timeframeChart.data.datasets[0].data = [0, 0, 0];
                monthlyChart.data.labels = [];
                monthlyChart.data.datasets[0].data = [];
                
                equityChart.update();
                winLossChart.update();
                strategyChart.update();
                timeframeChart.update();
                monthlyChart.update();
                return;
            }
            
            // Update equity curve
            equityChart.data.labels = equityCurve.map((_, i) => `Trade ${i+1}`);
            equityChart.data.datasets[0].data = equityCurve;
            
            // Update win/loss chart
            const wins = trades.filter(t => t.profit > 0).length;
            const losses = trades.filter(t => t.profit <= 0).length;
            winLossChart.data.datasets[0].data = [wins, losses];
            
            // Update strategy chart (placeholder data)
            strategyChart.data.datasets[0].data = [1850, 1240, 2100, 850];
            
            // Update timeframe chart (placeholder data)
            timeframeChart.data.datasets[0].data = [45, 35, 20];
            
            equityChart.update();
            winLossChart.update();
            strategyChart.update();
            timeframeChart.update();
            
            // Update monthly stats
            updateMonthlyStats();
        };
        
        // Update performance metrics
        const updateMetrics = () => {
            if (trades.length === 0) {
                document.getElementById('total-trades').textContent = '0';
                document.getElementById('win-rate').textContent = '0%';
                document.getElementById('avg-win').textContent = '₹0';
                document.getElementById('avg-loss').textContent = '₹0';
                document.getElementById('total-pl').textContent = '₹0';
                document.getElementById('monthly-pl').textContent = '₹0';
                document.getElementById('best-trade').textContent = '₹0';
                document.getElementById('worst-trade').textContent = '₹0';
                document.getElementById('profit-factor').textContent = '0.00';
                document.getElementById('expectancy').textContent = '₹0';
                document.getElementById('sharpe-ratio').textContent = '0.00';
                document.getElementById('max-drawdown').textContent = '0.0%';
                return;
            }
            
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => t.profit > 0);
            const losingTrades = trades.filter(t => t.profit <= 0);
            const winRate = Math.round((winningTrades.length / totalTrades) * 100);
            const avgWin = winningTrades.length > 0 ? 
                Math.round(winningTrades.reduce((sum, t) => sum + t.profit, 0) / winningTrades.length) : 0;
            const avgLoss = losingTrades.length > 0 ? 
                Math.round(losingTrades.reduce((sum, t) => sum + t.profit, 0) / losingTrades.length) : 0;
            const totalPL = trades.reduce((sum, t) => sum + t.profit, 0);
            const bestTrade = Math.max(...trades.map(t => t.profit));
            const worstTrade = Math.min(...trades.map(t => t.profit));
            
            // Calculate monthly P&L (simplified)
            const currentMonth = new Date().getMonth();
            const monthlyTrades = trades.filter(t => new Date(t.date).getMonth() === currentMonth);
            const monthlyPL = monthlyTrades.reduce((sum, t) => sum + t.profit, 0);
            
            // Calculate advanced metrics (simplified)
            const profitFactor = winningTrades.length > 0 && losingTrades.length > 0 ? 
                (winningTrades.reduce((sum, t) => sum + t.profit, 0) / 
                 Math.abs(losingTrades.reduce((sum, t) => sum + t.profit, 0))).toFixed(2) : '0.00';
            
            const expectancy = ((winRate / 100) * avgWin + ((100 - winRate) / 100) * avgLoss).toFixed(0);
            
            document.getElementById('total-trades').textContent = totalTrades;
            document.getElementById('win-rate').textContent = `${winRate}%`;
            document.getElementById('avg-win').textContent = `₹${avgWin}`;
            document.getElementById('avg-loss').textContent = `₹${avgLoss}`;
            document.getElementById('total-pl').textContent = `₹${totalPL}`;
            document.getElementById('monthly-pl').textContent = `₹${monthlyPL}`;
            document.getElementById('best-trade').textContent = `₹${bestTrade}`;
            document.getElementById('worst-trade').textContent = `₹${worstTrade}`;
            document.getElementById('profit-factor').textContent = profitFactor;
            document.getElementById('expectancy').textContent = `₹${expectancy}`;
        };
        
        // Update trade history table
        const updateTradeTable = () => {
            const tableBody = document.querySelector('#trades-table tbody');
            tableBody.innerHTML = '';
            
            if (trades.length === 0) {
                tableBody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="9">
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <h3>No trades recorded yet</h3>
                                <p>Add your first trade using the Data Entry tab</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let cumulativePL = 0;
            
            trades.forEach((trade, index) => {
                cumulativePL += trade.profit;
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${new Date(trade.date).toLocaleDateString()}</td>
                    <td>${trade.symbol}</td>
                    <td>${trade.direction}</td>
                    <td>${trade.entry.toFixed(2)}</td>
                    <td>${trade.exit.toFixed(2)}</td>
                    <td>${trade.quantity}</td>
                    <td class="${trade.profit >= 0 ? 'positive' : 'negative'}">${trade.profit >= 0 ? '+' : ''}${trade.profit.toFixed(2)}</td>
                    <td class="${cumulativePL >= 0 ? 'positive' : 'negative'}">${cumulativePL >= 0 ? '+' : ''}${cumulativePL.toFixed(2)}</td>
                    <td>
                        <button class="btn-secondary" onclick="deleteTrade('${trade.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        };
        

        
        // Form submission handler
        document.getElementById('trade-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form values
            const symbol = document.getElementById('symbol').value;
            const entry = parseFloat(document.getElementById('entry').value);
            const exit = parseFloat(document.getElementById('exit').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const direction = document.getElementById('direction').value;
            const date = document.getElementById('date').value;
            const strategy = document.getElementById('strategy').value;
            const timeframe = document.getElementById('timeframe').value;
            const risk = parseFloat(document.getElementById('risk').value) || 0;
            const notes = document.getElementById('notes').value;
            
            // Calculate P&L
            let profit;
            if (direction === 'long') {
                profit = (exit - entry) * quantity;
            } else {
                profit = (entry - exit) * quantity;
            }
            
            // Create trade object
            const trade = {
                date,
                symbol,
                direction,
                entry,
                exit,
                quantity,
                profit,
                strategy,
                timeframe,
                risk,
                notes
            };
            
            // Add to Firebase and update UI
            addTrade(trade)
                .then(() => {
                    // Update UI
                    updateTradeTable();
                    updateCharts();
                    updateMetrics();
                    updateMonthlyStats();
                    updateExportStats();
                    
                    // Reset form
                    this.reset();
                    
                    // Set date to today
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('date').value = today;
                    
                    // Show success message
                    alert(`Trade added successfully! P&L: ₹${profit.toFixed(2)}`);
                })
                .catch(error => {
                    console.error('Error adding trade:', error);
                    alert('Error adding trade. Please try again.');
                });
        });
        
        // Export data
        document.getElementById('export-btn').addEventListener('click', () => {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Date,Symbol,Direction,Entry,Exit,Quantity,P&L,Strategy,Timeframe,Risk,Notes\n"
                + trades.map(trade => 
                    `${trade.date},${trade.symbol},${trade.direction},${trade.entry},${trade.exit},${trade.quantity},${trade.profit},${trade.strategy},${trade.timeframe},${trade.risk},"${trade.notes}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "trading_journal_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Clear history
        document.getElementById('clear-btn').addEventListener('click', async () => {
            if (trades.length === 0) {
                alert('No trades to clear!');
                return;
            }
            
            if (confirm('Are you sure you want to clear all trade history? This cannot be undone.')) {
                try {
                    // Delete all trades from Firebase
                    for (const trade of trades) {
                        await deleteTrade(trade.id);
                    }
                    
                    // Clear local arrays and localStorage as backup
                    trades = [];
                    equityCurve = [0];
                    localStorage.removeItem('trades');
                    localStorage.removeItem('equityCurve');
                    
                    updateTradeTable();
                    updateCharts();
                    updateMetrics();
                    updateMonthlyStats();
                    updateExportStats();
                    
                    alert('All trade history has been cleared.');
                } catch (error) {
                    console.error('Error clearing trades:', error);
                    alert('Error clearing trades. Please try again.');
                }
            }
        });
        
        // Set up export buttons
        document.getElementById('export-csv').addEventListener('click', exportToCSV);
        document.getElementById('export-txt').addEventListener('click', exportToTXT);
        document.getElementById('export-json').addEventListener('click', exportToJSON);
        
        // Initialize the application
        window.addEventListener('load', async () => {
            try {
                // Initialize Firebase data
                await initializeData();
                //setupRealtimeListener();
                
                // Initialize charts and UI
                initCharts();
                updateTradeTable();
                updateCharts();
                updateMetrics();
                updateMonthlyStats();
                updateExportStats();
                
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
            } catch (error) {
                console.error('Error initializing application:', error);
                alert('Error initializing application. Please refresh the page.');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
    auth.signOut();
});
    </script>
</body>
</html>